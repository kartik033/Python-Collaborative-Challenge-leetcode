<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Python Challenge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM (Development versions for simplicity) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX and modern JS support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection,
            query,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script to use
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            collection,
            query,
            setLogLevel
        };
    </script>

    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Inconsolata', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* Apply smooth scrolling and use Inter font */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better look in dark mode */
        textarea::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        textarea::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="root">
        <!-- React App mounts here -->
    </div>

    <!-- The main application script, using Babel to process JSX -->
    <script type="text/babel">
        // Global variables must be redefined or sourced locally for standalone operation
        // IMPORTANT: The Firebase configuration below has been successfully updated.
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBvJBuJsfu6dMwY5779HJtxL5ZxuW9E6hk", 
            authDomain: "python-collaborative-challenge.firebaseapp.com",
            projectId: "python-collaborative-challenge",
            storageBucket: "python-collaborative-challenge.firebasestorage.app",
            messagingSenderId: "50346389978",
            appId: "1:50346389978:web:26649d7799c25b8bfa10e3"
        };
        
        // In a standalone environment, we use a fixed app ID for pathing.
        const appId = 'collaborative-py-app-standalone';
        const initialAuthToken = null; // No custom token outside of Canvas
        
        // --- Setup Firebase Global Functions (Accessed via window.firebase) ---
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel, onAuthStateChanged } = window.firebase;
        setLogLevel('debug'); // Set Firebase log level for debugging

        // --- Constants & Mock Data ---
        const PROBLEM_DOC_ID = 'currentProblem';
        
        const MOCK_PROBLEMS = [
          { id: 'P001', title: 'The Multi-Sum Maze (Two Sum)', statement: "Given an array of integers `nums` and a target integer `target`, return indices of the two numbers such that they add up to `target`. Write a function `def two_sum(nums, target):`.", difficulty: 'Easy', fnName: 'two_sum', testCases: [{ input: { nums: [2, 7, 11, 15], target: 9 }, expected: [0, 1] }, { input: { nums: [3, 2, 4], target: 6 }, expected: [1, 2] }, { input: { nums: [3, 3], target: 6 }, expected: [0, 1] }] },
          { id: 'P002', title: 'Reverse Linked List Iteratively', statement: "Reverse a singly linked list. For this exercise, return the reversed array representation of the input array. Write a function `def reverse_list(arr):`.", difficulty: 'Medium', fnName: 'reverse_list', testCases: [{ input: { arr: [1, 2, 3, 4, 5] }, expected: [5, 4, 3, 2, 1] }, { input: { arr: [1] }, expected: [1] }, { input: { arr: [] }, expected: [] }] },
          { id: 'P003', title: 'Balanced Parentheses Checker', statement: "Given a string `s` containing just the characters '(', ')', '{', '}', '[' and ']', determine if the input string is valid. Write a function `def is_valid(s):`.", difficulty: 'Hard', fnName: 'is_valid', testCases: [{ input: { s: "(){}[]" }, expected: true }, { input: { s: "([{}])" }, expected: true }, { input: { s: "([)]" }, expected: false }, { input: { s: "[" }, expected: false }] },
        ];
        
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Utility Functions for TTS (WAV conversion) ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset++, s.charCodeAt(i));
                }
            }

            writeString('RIFF'); 
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4; 
            writeString('WAVE'); 

            writeString('fmt '); 
            view.setUint32(offset, 16, true); offset += 4; 
            view.setUint16(offset, 1, true); offset += 2; 
            view.setUint16(offset, numChannels, true); offset += 2; 
            view.setUint32(offset, sampleRate, true); offset += 4; 
            view.setUint32(offset, byteRate, true); offset += 4; 
            view.setUint16(offset, blockAlign, true); offset += 2; 
            view.setUint16(offset, 16, true); offset += 2; 

            writeString('data'); 
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4; 

            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // Generic fetch with exponential backoff for API calls
        const fetchWithRetry = async (url, options, maxRetries = 3) => {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    console.warn(`Fetch attempt ${i + 1} failed. Retrying in ${Math.pow(2, i)}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            throw lastError;
        };

        // --- Pyodide Setup Function ---
        const loadPyodide = async () => {
          if (window.pyodide) {
            return window.pyodide;
          }
          
          // Dynamically load the Pyodide script
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
            script.onload = async () => {
              try {
                const pyodideInstance = await window.loadPyodide({
                  indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/',
                });
                resolve(pyodideInstance);
              } catch (e) {
                reject(e);
              }
            };
            script.onerror = (e) => reject(new Error("Failed to load pyodide.js"));
            document.head.appendChild(script);
          });
        };


        // Function to generate a Python template
        const getTemplate = (problemId) => {
            const problem = MOCK_PROBLEMS.find(p => p.id === problemId);
            if (!problem) return "# Problem not found";

            const params = problemId === 'P001' ? 'nums, target' : 
                           problemId === 'P002' ? 'arr' :
                           problemId === 'P003' ? 's' :
                           'input';

            return `def ${problem.fnName}(${params}):
    """
    Solve the problem here in Python.
    The code will be executed against test cases using Pyodide.
    """
    
    # Your solution here. Example:
    # return [0, 1] 
    return None
`;
        };

        // --- Main Component ---
        function App() {
          const [db, setDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [pyodide, setPyodide] = useState(null);
          const [isPyodideLoading, setIsPyodideLoading] = useState(true);
          
          const [currentProblem, setCurrentProblem] = useState(null);
          const [userCode, setUserCode] = useState('');
          const [testResult, setTestResult] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const [showNotification, setShowNotification] = useState(false);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [selectedDifficulty, setSelectedDifficulty] = useState('All'); 
          
          // History State
          const [solvedHistory, setSolvedHistory] = useState([]);
          
          // Guidance states
          const [hint, setHint] = useState(null);
          const [concept, setConcept] = useState(null);
          const [explanation, setExplanation] = useState(null);
          const [youtubeLink, setYoutubeLink] = useState(null);
          const [showExplanation, setShowExplanation] = useState(false);
          const [isGettingGuidance, setIsGettingGuidance] = useState(false);
          
          // Memoized Firestore reference getter for the current problem
          const getProblemRef = useCallback((dbInstance) => doc(collection(dbInstance, `artifacts/${appId}/public/data/problemSets`), PROBLEM_DOC_ID), []);
          
          // Memoized Firestore reference getter for the user's solved history
          const getSolvedHistoryRef = useCallback((dbInstance, uid) => collection(dbInstance, `artifacts/${appId}/users/${uid}/solved_problems`), []);


          // 1. Firebase Initialization and Authentication
          useEffect(() => {
            const uidPlaceholder = crypto.randomUUID();
            
            if (Object.keys(FIREBASE_CONFIG).length === 0 || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
              console.error("FIREBASE_CONFIG is not set. Using local mode.");
              setUserId(uidPlaceholder);
              setIsAuthReady(true);
              return;
            }

            let authCleanup = () => {};
            
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                const firestore = getFirestore(app);
                const firebaseAuth = getAuth(app);
                
                setDb(firestore);

                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            // Use anonymous sign-in for simplicity in a hosted environment
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (error) {
                        console.error('Firebase Auth Error during sign-in:', error);
                        await signInAnonymously(firebaseAuth).catch(e => console.error("Anonymous sign-in failed:", e));
                    }
                    
                    authCleanup = onAuthStateChanged(firebaseAuth, user => {
                        const uid = user ? user.uid : uidPlaceholder;
                        setUserId(uid);
                        setIsAuthReady(true); // Auth is stable
                    });
                };

                authenticate();
            } catch (error) {
                console.error("Critical Firebase Initialization Error:", error);
                setUserId(uidPlaceholder);
                setIsAuthReady(true); 
            }

            return () => authCleanup();
          }, [getProblemRef]);
          
          // 2. Pyodide Initialization
          useEffect(() => {
            loadPyodide().then(instance => {
              setPyodide(instance);
              setIsPyodideLoading(false);
              console.log('Pyodide loaded successfully.');
            }).catch(error => {
              console.error('Failed to load Pyodide:', error);
              setIsPyodideLoading(false);
            });
          }, []);

          // 3. Real-time Listener for Current Problem (Public)
          useEffect(() => {
            if (!isAuthReady || !db || !userId) return;

            const problemRef = getProblemRef(db);
            const unsubscribe = onSnapshot(problemRef, (docSnap) => {
              if (docSnap.exists()) {
                const problemData = docSnap.data();
                setCurrentProblem(problemData);
                // Reset guidance state on new problem load
                setHint(null);
                setConcept(null);
                setExplanation(null);
                setYoutubeLink(null);
                setShowExplanation(false);
              } else {
                setCurrentProblem(null);
              }
            }, (error) => {
              console.error('Firestore problem subscription failed:', error);
            });

            return () => unsubscribe();
          }, [isAuthReady, db, userId, getProblemRef]);
          
          // 4. Real-time Listener for Solved History (Private)
          useEffect(() => {
            if (!isAuthReady || !db || !userId) return;

            const historyCollectionRef = getSolvedHistoryRef(db, userId);
            
            const unsubscribe = onSnapshot(query(historyCollectionRef), (querySnapshot) => {
                const history = [];
                querySnapshot.forEach(doc => {
                    history.push({ id: doc.id, ...doc.data() });
                });
                setSolvedHistory(history);
            }, (error) => {
                console.error('Firestore history subscription failed:', error);
            });

            return () => unsubscribe();
          }, [isAuthReady, db, userId, getSolvedHistoryRef]);


          // Set initial code state when a new problem loads
          useEffect(() => {
            const userSubmission = currentProblem?.submissions?.[userId];
            
            if (currentProblem) {
              const template = getTemplate(currentProblem.id);
              setUserCode(userSubmission ? userSubmission.code : template);
              setTestResult(userSubmission ? userSubmission.resultMessage : '');
            }
          }, [currentProblem, userId]); 

          // --- Gemini API for Guidance ---
          const getProblemGuidance = useCallback(async () => {
            if (!currentProblem || isGettingGuidance) return;
            setIsGettingGuidance(true);
            
            const query = `Provide a concise hint, the core computer science concept, a detailed explanation of the concept's application, and a relevant YouTube link to study this problem: "${currentProblem.title}". Problem Statement: "${currentProblem.statement}". Ensure the explanation is geared toward a Python implementation.`;
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are an expert coding tutor specializing in Python. Generate guidance content structured as JSON." }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "hint": { "type": "STRING", "description": "A concise, single-sentence clue to solve the problem, without giving away the full solution. Should mention relevant Python data structures." },
                            // This is the CORRECTED line 327:
                            "concept": { "type": "STRING", "description": "The main computer science or mathematical concept required to solve the problem (e.g., 'Hash Map', 'Two Pointers', 'Recursion')." },
                            "explanation": { "type": "STRING", "description": "A detailed, two-paragraph explanation of the core concept and how it applies to this specific type of problem, focusing on Python best practices." },
                            "youtubeLink": { "type": "STRING", "description": "A relevant, generic YouTube URL discussing the core concept (e.g., a Python Two Sum video for P001). MUST start with https://www.youtube.com/watch?v=" }
                        },
                        required: ["hint", "concept", "explanation", "youtubeLink"]
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const parsed = JSON.parse(jsonText);
                    setHint(parsed.hint);
                    setConcept(parsed.concept);
                    setExplanation(parsed.explanation);
                    setYoutubeLink(parsed.youtubeLink);
                } else {
                    console.error('Guidance API response error:', result);
                    setHint('Failed to load guidance. Please try again.');
                }

            } catch (error) {
                console.error('Error fetching problem guidance:', error);
                setHint('Error fetching hint. Check console for details.');
            } finally {
                setIsGettingGuidance(false);
            }
          }, [currentProblem, isGettingGuidance]);


          // Problem Actions (Pick Random)
          const pickRandomProblem = useCallback(async () => {
            if (!db || !userId) {
                setTestResult('Cannot pick problem: Firebase not configured or loading.');
                setShowNotification(true);
                setTimeout(() => setShowNotification(false), 3000);
                return;
            }

            setIsLoading(true);
            setTestResult('');
            setHint(null); 

            try {
              const availableProblems = MOCK_PROBLEMS.filter(p => 
                selectedDifficulty === 'All' || p.difficulty === selectedDifficulty
              );

              if (availableProblems.length === 0) {
                setIsLoading(false);
                setTestResult(`No ${selectedDifficulty} problems available.`);
                setShowNotification(true);
                setTimeout(() => setShowNotification(false), 3000);
                return;
              }

              const problem = availableProblems[Math.floor(Math.random() * availableProblems.length)];
              
              const newProblemData = {
                id: problem.id,
                title: problem.title,
                statement: problem.statement,
                difficulty: problem.difficulty,
                fnName: problem.fnName, 
                testCases: problem.testCases,
                ownerId: userId,
                submissions: {}, 
                timestamp: Date.now(),
              };

              await setDoc(getProblemRef(db), newProblemData);
              setShowNotification(true);
              setTimeout(() => setShowNotification(false), 3000);

            } catch (error) {
              console.error('Error picking random problem:', error);
            } finally {
              setIsLoading(false);
            }
          }, [db, userId, getProblemRef, selectedDifficulty]);

          
          // --- Python Test Runner (Pyodide) ---
          const runPythonTests = useCallback(async (code, fnName, testCases) => {
            if (!pyodide) {
              return { passed: false, message: 'Pyodide interpreter is not loaded yet.' };
            }

            try {
              await pyodide.runPythonAsync(code);

              let allPassed = true;
              let results = [];

              for (const [index, test] of testCases.entries()) {
                const inputArgs = Object.values(test.input);
                const expected = test.expected;
                
                const pyArgs = inputArgs.map(arg => JSON.stringify(arg).replace(/"/g, "'")).join(', ');
                
                const pyTestCall = `
import json
import traceback

def safe_call():
    args = [json.loads(arg) for arg in [${pyArgs}]] 
    return ${fnName}(*args)

try:
    actual = safe_call()
    actual_repr = actual.__repr__()
    js_actual = pyodide.to_js(actual, dict_converter=Object.fromEntries)
    
    print(json.dumps({'actual': js_actual, 'actual_repr': actual_repr}))
    
except Exception as e:
    print(json.dumps({'error': traceback.format_exc()}))
`;
                
                let output = '';
                pyodide.setStdout({ raw: (text) => { output += text + '\n'; } });

                try {
                    await pyodide.runPythonAsync(pyTestCall);
                    
                    const jsonLine = output.trim().split('\n').find(line => line.startsWith('{') && line.endsWith('}'));
                    const pyResult = JSON.parse(jsonLine || '{}');

                    if (pyResult.error) {
                        allPassed = false;
                        if (results.length === 0) {
                            const errorMsg = pyResult.error.split('\n').filter(line => line.trim()).slice(-3).join('\n').trim();
                            results.push({ index: index + 1, passed: false, message: `Runtime Error in Test ${index + 1}:\n${errorMsg}` });
                        }
                    } else {
                        const actual = pyResult.actual;
                        const isMatch = JSON.stringify(actual) === JSON.stringify(expected);

                        if (!isMatch) {
                            allPassed = false;
                            if (results.length === 0) {
                                results.push({ index: index + 1, passed: false, 
                                    message: `Failed Test ${index + 1}. Expected: ${JSON.stringify(expected)}, Got: ${pyResult.actual_repr || JSON.stringify(actual)}` 
                                });
                            }
                        }
                    }

                } catch (execError) {
                  allPassed = false;
                  results.push({ index: index + 1, passed: false, message: `Harness Error (check console): ${execError.message}` });
                  console.error("Pyodide Harness Error:", execError);
                }
              }

              const passedCount = testCases.length - results.length;

              return {
                passed: allPassed,
                message: allPassed 
                  ? `‚úÖ All ${testCases.length} tests passed!` 
                  : results[0]?.message || `‚ùå Failed ${testCases.length - passedCount} out of ${testCases.length} tests.`,
              };

            } catch (error) {
              let errorMessage = String(error);
              if (errorMessage.includes("SyntaxError") || errorMessage.includes("NameError")) {
                  const lines = errorMessage.split('\n');
                  const relevantLine = lines.filter(line => line.startsWith('  File "<exec>",')).pop();
                  errorMessage = relevantLine ? `Syntax/Name Error:\n${lines.pop().trim()}` : `Compilation Error: ${errorMessage.split('\n').pop().trim()}`;
              }
              return { passed: false, message: `Python Error: ${errorMessage}` };
            }
          }, [pyodide]);


          // Submission Action
          const submitSolution = async () => {
            if (!db || !userId || !currentProblem || isLoading || isPyodideLoading || !pyodide) return;
            setIsLoading(true);

            let testRun = { passed: false, message: "Pyodide not ready or failed to load." };
            
            if (pyodide) {
                testRun = await runPythonTests(userCode, currentProblem.fnName, currentProblem.testCases);
            }
            
            setTestResult(testRun.message);
            const currentUserName = `User-${userId ? userId.substring(0, 4) : 'Guest'}`;

            try {
              const problemRef = getProblemRef(db);
              
              const newSubmission = {
                code: userCode,
                passed: testRun.passed,
                resultMessage: testRun.message,
                timestamp: Date.now(),
                language: 'Python', 
                userName: currentUserName, 
              };

              // 1. Update the public collaborative submission status
              await setDoc(problemRef, {
                submissions: {
                  ...currentProblem.submissions,
                  [userId]: newSubmission,
                }
              }, { merge: true });

              // 2. If tests passed, update the user's private solved history
              if (testRun.passed) {
                const solvedDocRef = doc(getSolvedHistoryRef(db, userId), currentProblem.id);
                await setDoc(solvedDocRef, {
                    title: currentProblem.title,
                    difficulty: currentProblem.difficulty,
                    solvedAt: Date.now(),
                    code: userCode,
                }, { merge: true });
              }

            } catch (error) {
              console.error('Error submitting solution/updating history:', error);
            } finally {
              setIsLoading(false);
            }
          };

          // Text-to-Speech Generation 
          const speakProblem = async () => {
            if (!currentProblem || isSpeaking) return;
            setIsSpeaking(true);
            
            try {
                const ttsPrompt = `Say clearly: The current problem is titled: ${currentProblem.title}. The statement is: ${currentProblem.statement}`;
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: ttsPrompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);

                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.onended = () => setIsSpeaking(false);
                    audio.play().catch(e => console.error("Audio playback failed:", e));

                } else {
                    console.error("TTS audio data or format missing:", result);
                    setIsSpeaking(false);
                }

            } catch (error) {
                console.error('Error generating TTS:', error);
                setIsSpeaking(false);
            }
          };


          const hasSubmissions = currentProblem && Object.keys(currentProblem.submissions).length > 0;
          const currentUserName = useMemo(() => `User-${userId ? userId.substring(0, 4) : 'Guest'}`, [userId]);
          
          if (!isAuthReady || isPyodideLoading) {
            let message = isPyodideLoading ? 'Downloading Python Interpreter (Pyodide)...' : 'Loading Collaborative Environment...';
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-900">
                <div className="text-white text-xl p-4 rounded-xl bg-gray-800 shadow-lg animate-pulse">
                  {message}
                </div>
              </div>
            );
          }

          const isSubmissionDisabled = isLoading || isPyodideLoading || !pyodide;

          return (
            <div className="min-h-screen bg-gray-900 p-4 md:p-8 text-white font-sans">
              <div className="max-w-4xl mx-auto">
                
                {/* Header & ID */}
                <header className="mb-8 border-b border-gray-700 pb-4">
                    <div className="flex justify-between items-start mb-4">
                        <h1 className="text-4xl font-extrabold text-green-400">
                            <span className="text-white">Collaborative</span> <span className="text-yellow-400">Python</span> Code Challenge
                        </h1>
                        <div className="text-right">
                            <div className="text-2xl font-black text-white p-2 bg-indigo-700 rounded-lg shadow-md">
                                Solved: <span className="text-yellow-300">{solvedHistory.length}</span>
                            </div>
                        </div>
                    </div>
                  
                  <p className="text-sm text-gray-400">
                    App ID (for collaboration): <code className="text-yellow-400 text-xs break-all">{appId}</code>
                  </p>
                  <p className="text-sm text-gray-400 mt-2">
                    Your Temp ID: <span className="font-bold text-yellow-400">{currentUserName}</span>
                  </p>
                  
                  {FIREBASE_CONFIG.apiKey === "YOUR_API_KEY" && (
                    <div className="mt-4 p-3 bg-red-800 rounded-lg text-sm font-semibold">
                        ‚ö†Ô∏è **ACTION REQUIRED:** You must update the `FIREBASE_CONFIG` object in the `<script>` tag with your own Firebase details for persistent storage and collaboration to work!
                    </div>
                  )}
                </header>

                {/* Difficulty Toggles */}
                <div className="flex flex-col space-y-4 mb-6">
                    <h3 className="text-xl font-semibold text-gray-300">Select Difficulty:</h3>
                    <div className="flex flex-wrap justify-start space-x-2 p-2 bg-gray-800 rounded-xl shadow-inner border border-gray-700">
                    {['All', 'Easy', 'Medium', 'Hard'].map((diff) => (
                      <button
                        key={diff}
                        onClick={() => setSelectedDifficulty(diff)}
                        className={`px-4 py-2 text-sm font-semibold rounded-lg transition duration-200 mt-1 mb-1 ${
                          selectedDifficulty === diff
                            ? 'bg-indigo-600 text-white shadow-md transform scale-105'
                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                        } ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
                        disabled={isLoading}
                      >
                        {diff}
                      </button>
                    ))}
                  </div>
                  
                  {/* Problem Picker Button */}
                  <div className="flex justify-between items-start mt-4">
                    <button
                      onClick={pickRandomProblem}
                      disabled={isLoading}
                      className={`w-full md:w-auto px-6 py-3 rounded-xl font-bold shadow-lg transition duration-300 ease-in-out ${
                        isLoading 
                          ? 'bg-gray-700 text-gray-400 cursor-not-allowed' 
                          : 'bg-green-600 hover:bg-green-500 transform hover:scale-[1.02] active:scale-[0.98]'
                      }`}
                    >
                      {isLoading ? 'Picking...' : `Pick Random ${selectedDifficulty !== 'All' ? selectedDifficulty : ''} Problem`}
                    </button>
                    
                    {/* Notification */}
                    {showNotification && (
                      <div className="bg-blue-600 px-4 py-2 rounded-lg shadow-xl animate-pulse">
                        New Problem Selected!
                      </div>
                    )}
                  </div>
                </div>

                {/* Problem Display */}
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
                  {!currentProblem ? (
                    <div className="text-center py-10">
                      <p className="text-xl text-gray-400">No problem selected yet.</p>
                      <p className="text-md text-gray-500">Be the first to press "Pick Random Problem".</p>
                    </div>
                  ) : (
                    <>
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-3xl font-bold text-teal-400">
                          {currentProblem.title} 
                          <span className={`ml-3 text-sm font-medium px-3 py-1 rounded-full ${
                            currentProblem.difficulty === 'Easy' ? 'bg-green-700 text-green-200' :
                            currentProblem.difficulty === 'Medium' ? 'bg-yellow-700 text-yellow-200' :
                            'bg-red-700 text-red-200'
                          }`}>
                            {currentProblem.difficulty}
                          </span>
                        </h2>
                        <button
                            onClick={speakProblem}
                            disabled={isSpeaking || isLoading}
                            className="flex items-center p-2 rounded-full bg-indigo-600 hover:bg-indigo-500 text-white disabled:bg-gray-600"
                            title="Read Problem Statement (Text-to-Speech)"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={isSpeaking ? "animate-pulse" : ""}>
                                {isSpeaking ? (
                                    <path d="M12 2a1 1 0 0 0-1 1v18a1 1 0 0 0 2 0V3a1 1 0 0 0-1-1zM6 6a1 1 0 0 0-1 1v10a1 1 0 0 0 2 0V7a1 1 0 0 0-2 0zM18 6a1 1 0 0 0-1 1v10a1 1 0 0 0 2 0V7a1 1 0 0 0-2 0z"/>
                                ) : (
                                    <path d="M15.5 2a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-.5.5h-2.5a.5.5 0 0 1-.5-.5v-2.5a.5.5 0 0 1 .5-.5h2.5zM12 11a1 1 0 0 0-1 1v8a1 1 0 0 0 2 0v-8a1 1 0 0 0-1-1zM5 13a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-1-1zM19 13a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-1-1z"/>
                                )}
                            </svg>
                        </button>
                      </div>
                      
                      <p className="text-gray-300 whitespace-pre-wrap mb-4">{currentProblem.statement}</p>

                      <div className="mt-4 pt-4 border-t border-gray-700">
                        <h3 className="text-xl font-semibold mb-2 text-gray-300">Example Test Case:</h3>
                        <div className="bg-gray-900 p-3 rounded-lg text-sm font-mono overflow-x-auto">
                            <p><span className="text-yellow-500">Input:</span> {JSON.stringify(currentProblem.testCases[0].input)}</p>
                            <p><span className="text-green-500">Output:</span> {JSON.stringify(currentProblem.testCases[0].expected)}</p>
                        </div>
                      </div>
                    </>
                  )}
                </div>

                {/* Guidance Section */}
                {currentProblem && (
                    <div className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
                        <h2 className="text-3xl font-bold text-blue-400 mb-4 flex items-center justify-between">
                            Python Problem Guidance
                            <button
                                onClick={hint ? () => setShowExplanation(prev => !prev) : getProblemGuidance}
                                disabled={isGettingGuidance}
                                className={`px-4 py-2 rounded-lg font-semibold text-sm transition duration-200 ${
                                    isGettingGuidance 
                                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                        : showExplanation 
                                            ? 'bg-red-600 hover:bg-red-500 text-white'
                                            : 'bg-blue-600 hover:bg-blue-500 text-white'
                                }`}
                            >
                                {isGettingGuidance ? 'Fetching...' : hint ? (showExplanation ? 'Hide Explanation' : 'View Concept') : 'Get Python Hint'}
                            </button>
                        </h2>

                        {/* Hint Display */}
                        {hint && (
                            <div className="mb-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <p className="font-semibold text-lg text-yellow-300 mb-1">üí° Python Hint:</p>
                                <p className="text-gray-300 italic">{hint}</p>
                            </div>
                        )}
                        
                        {/* Explanation Display (Collapsible) */}
                        {showExplanation && explanation && concept && (
                            <div className="mt-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <h3 className="text-xl font-bold text-green-400 mb-2">Core Python Concept: {concept}</h3>
                                <p className="whitespace-pre-wrap text-gray-300 mb-4">{explanation}</p>
                                
                                {youtubeLink && (
                                    <div className="flex items-center text-sm text-blue-400 hover:text-blue-300">
                                        <span className="mr-2">üì∫</span>
                                        <a href={youtubeLink} target="_blank" rel="noopener noreferrer" className="underline font-medium">
                                            Watch Python Video on {concept}
                                        </a>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* Loader for Hint */}
                        {isGettingGuidance && !hint && (
                            <div className="text-center py-4 text-gray-400 animate-pulse">
                                Generating Python hint and concept explanation...
                            </div>
                        )}
                    </div>
                )}

                {/* Code Editor and Submission */}
                {currentProblem && (
                  <div className="mb-8">
                    <h2 className="text-3xl font-bold mb-4">Your Python Solution</h2>
                    
                    <textarea
                      value={userCode}
                      onChange={(e) => setUserCode(e.target.value)}
                      rows="12"
                      className="w-full p-4 bg-gray-700 border border-gray-600 rounded-xl font-mono text-sm text-white resize-none focus:ring-green-500 focus:border-green-500 outline-none"
                      placeholder="Write your Python function here..."
                    />

                    <div className="flex flex-col md:flex-row justify-between items-center mt-4 space-y-3 md:space-y-0 md:space-x-4">
                      <button
                        onClick={submitSolution}
                        disabled={isSubmissionDisabled}
                        className={`w-full md:w-auto px-8 py-3 rounded-xl font-bold shadow-xl transition duration-300 ease-in-out ${
                          isSubmissionDisabled 
                            ? 'bg-gray-700 text-gray-400 cursor-not-allowed' 
                            : 'bg-indigo-600 hover:bg-indigo-500 transform hover:scale-[1.02] active:scale-[0.98]'
                        }`}
                      >
                        {isLoading ? 'Running Python Tests...' : 'Run Python Tests & Submit'}
                      </button>

                      <div className={`text-xl font-semibold p-3 rounded-xl w-full md:w-auto text-center ${
                        testResult.startsWith('‚úÖ') ? 'bg-green-900 text-green-300' : 
                        testResult.includes('Error') || testResult.startsWith('‚ùå') ? 'bg-red-900 text-red-300' :
                        'bg-gray-700 text-gray-400'
                      }`}>
                        {testResult || 'Awaiting Submission...'}
                      </div>
                    </div>
                  </div>
                )}

                {/* Submissions Leaderboard */}
                {currentProblem && (
                  <div className="mt-8">
                    <h2 className="text-3xl font-bold mb-4">Collaborative Submissions (Python)</h2>
                    
                    <div className="bg-gray-800 p-4 rounded-xl shadow-inner border border-gray-700">
                      {hasSubmissions ? (
                        <div className="space-y-3">
                          {Object.entries(currentProblem.submissions)
                            .sort(([, a], [, b]) => b.timestamp - a.timestamp)
                            .map(([submittingUserId, submission]) => (
                              <div 
                                key={submittingUserId} 
                                className={`p-4 rounded-lg flex justify-between items-center ${
                                  submission.passed ? 'bg-green-950/50 border border-green-700' : 'bg-red-950/50 border border-red-700'
                                }`}
                              >
                                <div>
                                  <p className={`font-bold ${submittingUserId === userId ? 'text-yellow-400' : 'text-white'}`}>
                                    {submission.userName || submittingUserId}
                                    {submittingUserId === userId && <span className="ml-2 text-xs font-normal text-gray-400">(Me)</span>}
                                  </p>
                                  <p className="text-sm text-gray-400 italic">
                                    {new Date(submission.timestamp).toLocaleTimeString()}
                                  </p>
                                </div>
                                <div className="text-right">
                                  <p className="font-semibold text-lg">
                                    {submission.passed ? 'PASSED ALL TESTS' : 'FAILED'}
                                  </p>
                                  <p className="text-xs text-gray-300 whitespace-pre-wrap">{submission.resultMessage.substring(0, 100)}...</p>
                                </div>
                              </div>
                            ))}
                        </div>
                      ) : (
                        <p className="text-gray-400 text-center py-6">No solutions submitted yet. Be the first!</p>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Mount the React component
        ReactDOM.render(<App />, document.getElementById('root'));

        // Load Pyodide script dynamically after everything else to avoid blocking
        const pyodideScript = document.createElement('script');
        pyodideScript.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
        document.body.appendChild(pyodideScript);

    </script>
</body>
</html>